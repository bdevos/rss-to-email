name: Send email

on:
  schedule:
    - cron: '0/10 * * * *'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          cache: 'npm'

      - name: Create .env file
        uses: SpicyPizza/create-envfile@v1.3.0
        with:
          envkey_DEBUG: false
          envkey_SOME_API_KEY: '123456abcdef'
          envkey_SECRET_KEY: ${{ secrets.SECRET_KEY }}

      - run: npm ci
      - run: npm run email -- actionUrl=${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: File Existence
        id: check_email
        uses: andstor/file-existence-action@v2.0.0
        with:
          files: 'dist/email.html'

      - name: Send email
        if: steps.check_email.outputs.files_exists == 'true'
        uses: dawidd6/action-send-mail@v3.7.1
        with:
          server_address: smtp.fastmail.com
          server_port: 587

          username: ${{secrets.MAIL_USERNAME}}
          password: ${{secrets.MAIL_PASSWORD}}

          subject: RSS to Email
          to: ${{secrets.MAIL_TO}}
          from: ${{secrets.MAIL_USERNAME}}

          html_body: file://dist/email.html
